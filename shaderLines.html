<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script id="vertex-shader" type="x-shader/x-vertex">
		uniform float time;
		uniform float buffer;
        uniform float speed;
        uniform bool blink;
		uniform vec3 p1;
		uniform vec3 p2;
		uniform vec3 color;
		varying vec3 iPosition;
		varying float dis;
		varying float alldis;
		varying vec4 icolor;
	
		void main(){
			icolor = vec4(color.r,color.g,color.b,1.0);
			iPosition = vec3(position);
			dis = distance(p1,position);
			alldis = distance(p1,p2);
			const float size = 1.5;
			float pointsize = size;
			if(dis < time * speed){
				pointsize =2.0* pointsize;

				if(time * speed > alldis ) {
					float a = (time * speed - alldis) / buffer;
					float b = 1.0-a;
					pointsize =pointsize - (size * a);
				}
			}
			gl_PointSize = pointsize;
			gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
		}
	</script>

    <script id="fragment-shader-7" type="x-shader/x-fragment">
		uniform float time;
		uniform float speed;
        uniform float buffer;
        uniform bool blink;
		varying vec3 iPosition;
		varying float dis;
		varying float alldis;
		varying vec4 icolor;
	
		void main( void ) {
			vec4 color;
			if(dis > time * speed){
				color = vec4(1,1,1,1.0);
			}else if(dis < time * speed ){
				
				color = vec4(icolor);

				if(time * speed > alldis ) {
					float a = (time * speed - alldis) / buffer;
					float b = 1.0-a;
					float cr = icolor.r;
					float cg = icolor.g;
					float cb = icolor.b;
					color = vec4(cr+(1.0-cr)*a, cg+(1.0-cg)*a, cb+(1.0-cb)*a,1.0);
				}
            }
            
            if(blink && time!=0.0){
                float alpha = abs(sin(0.1 * time ));
                color = vec4(color.rgb,alpha);
            }

			gl_FragColor = color;
			
		}
    </script>

    <script type="module">
        // vec4 c1 = vec4(1,1,1,1.0)
        // vec4 c2 = vec4(1,1,0,1.0)
        // color = vec4(mix(c1, c2, 0.1),1.0 * a);
        // color = vec4(vec3(mix(vec3(1,1,1), vec3(1,1,0), 2.0 * time - 1.0),1.0);
        // float ca = (iPosition.x - time)/size;
        // color = vec4(ca/2.8,ca/1.9,ca,1.0);

        import * as THREE from './node_modules/three/build/three.module.js';
        import { OrbitControls } from './node_modules/three/examples/jsm/controls/OrbitControls.js'
        import { APP } from './js/app.js';
        import { VRButton } from './js/VRButton.js';

        window.THREE = THREE; // Used by APP Scripts.
        window.VRButton = VRButton; // Used by APP Scripts.
        var player = new APP.Player();

        console.log(player)

        // debugger
        player.setScene(new THREE.Scene())
        player.setLight(new THREE.AmbientLight(0x353535, 3))
        player.setCamera(new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000))
        // player.camera.up = new THREE.Vector3( 0, 0, 1 )
        player.setControls(new OrbitControls(player.camera, player.dom))
        player.camera.position.set(50, 50, 50)
        player.setSize(window.innerWidth, window.innerHeight)
        // player.setAxesHelper(20)
        player.scene.add(new THREE.AxesHelper(200))
        // player.scene.add(new THREE.GridHelper(100, 100))

        window.addEventListener('resize', function () {
            player.setSize(window.innerWidth, window.innerHeight);
            player.camera.aspect = window.innerWidth / window.innerHeight;
            player.camera.updateProjectionMatrix();
        });

        var geometry = new THREE.BoxBufferGeometry(2, 2, 2);
        var material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        var cube = new THREE.Mesh(geometry, material);

        player.scene.add(cube);

        function getRandomReginPoint() {
            let shapeGroup = player.scene.getObjectByName('shapeGroup')
            let nowChosePosition
            shapeGroup.children.forEach((regin, index) => {
                if (index === Math.floor(Math.random() * 15)) {

                    nowChosePosition = regin.children[2].position
                }
            })
            return nowChosePosition
        }



        function createMaterial(vertexShader, fragmentShader) {
            var vertShader = document.getElementById(vertexShader).innerHTML; //获取顶点着色器的代码
            var fragShader = document.getElementById(fragmentShader).innerHTML; //获取片元着色器的代码
            //配置着色器里面的attribute变量的值
            var attributes = {};
            //配置着色器里面的uniform变量的值
            var uniforms = {
                time: { type: 'f', value: 0.0 },
                buffer: { type: 'f', value: 0.0 },
                speed: { type: 'f', value: 0.0 },
                blink: { type: 'bool', value: false },
                p1: {
                    type: "v3",
                    value: new THREE.Vector3()
                },
                p2: {
                    type: "v3",
                    value: new THREE.Vector3()
                },
                color: {
                    type: "v3",
                    value: new THREE.Vector3()
                }
            };
            var meshMaterial = new THREE.ShaderMaterial({
                uniforms: uniforms,
                defaultAttributeValues: attributes,
                vertexShader: vertShader,
                fragmentShader: fragShader,
                transparent: true
            });
            return meshMaterial;
        }

        function createdFlyline(start, end, color, blink) {
            var flyline;
            var curve = new THREE.LineCurve3(start, end)

            let dx = end.x - start.x
            let dy = end.y - start.y
            let dz = end.z - start.z
            let max = Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2) + Math.pow(dz, 2))
            var points = curve.getPoints(max * 35);

            var geometry = new THREE.Geometry();
            geometry.vertices = points;
            var material = createMaterial("vertex-shader", "fragment-shader-7");
            flyline = new THREE.Points(geometry, material);
            flyline.material.uniforms.time.value = 0.0;
            flyline.material.uniforms.buffer.value = 10.0;
            flyline.material.uniforms.speed.value = 0.3;
            flyline.material.uniforms.blink.value = blink;
            flyline.material.uniforms.p1.value = start;
            flyline.material.uniforms.p2.value = end;
            flyline.material.uniforms.color.value = color;
            flyline.maxx = max

            return flyline
        }




        player.play()

        document.body.appendChild(player.dom)

        let flylinegroup = new THREE.Group()
        flylinegroup.name = 'linesGroup'

        for (var i = 0; i < 5; i++) {
            // var minx = randomNum(-2000, -600) / 10;
            // var maxx = randomNum(600, 2000) / 10;
            var startNum = new THREE.Vector3(Math.random() * 50, Math.random() * 50, -20)
            var endNum = new THREE.Vector3(Math.random() * 50, Math.random() * 50, -20)
            let color = new THREE.Vector3((Math.random() + 0.1), (Math.random() + 0.1), (Math.random() + 0.1))

            // let startNum = new THREE.Vector3(50,50,-10)
            // let endNum = new THREE.Vector3(100,50,-10)
            // let startNum = getRandomReginPoint()
            // let endNum = getRandomReginPoint()
            let blink;
            Math.random() > 0.5 ? blink = true : blink = false
            let flyLine = createdFlyline(startNum, endNum, color, blink);
            // addFlyline(startNum,new THREE.Vector3(50,50,-50));

            flylinegroup.add(flyLine);
        }

        flylinegroup.rotateX(Math.PI / 2)
        player.scene.add(flylinegroup);


			//position: Vector3
			// x: -20.5
			// y: 0.5
			// z: -26
			// scale: Vector3
			// x: 1.35
			// y: 1.35
			// z: 1.35

			// var loader = new THREE.FileLoader();
			// loader.load( 'app.json', function ( text ) {

			// 	var player = new APP.Player();
			// 	player.load( JSON.parse( text ) );
			// 	player.setSize( window.innerWidth, window.innerHeight );
			// 	player.play();

			// 	document.body.appendChild( player.dom );

			// 	window.addEventListener( 'resize', function () {

			// 		player.setSize( window.innerWidth, window.innerHeight );

			// 	} );

			// } );

    </script>
</body>

</html>